\chapter{Analýza}

%% TODO: zde napsat prehledovy text o tom, co vsechno tato kapitola obsahuje

\section{Objektově orientovaný návrh software}
% -- rozebrat jaké návrhové koncepty lze podpořit
% -- rozebrat existující aspekty návrhu (design considerations)

\subsection{Koncepce návrhu software}

Existující koncepce (pojetí) návrhu software poskytují vývojářům základ, z něhož lze odvodit a aplikovat další sofistikované metody \cite{wiki:software_design}. Postupem času se vyvinula celá množina koncepcí návrhu software. Uveďme alespoň některé:

\paragraph{Abstrakce (Abstraction)} Princip abstrakce
\paragraph{Postupné zjemňování (Refinement)}
\paragraph{Modularita (Modularity)}
\paragraph{Architektura (Software Architecture)}
\paragraph{Hierarchie řízení (Control Hierarchy)}
\paragraph{Strukturální dělení (Structural Partitioning)}
\paragraph{Struktura dat (Data Structure)}
\paragraph{Softwarová procedura (Software Procedure)}
\paragraph{Zapouzdření (Information Hiding)}

%% \begin{itemize}
%% \item \emph{Abstraction} - Abstraction is the process or result of generalization by reducing the information content of a concept or an observable phenomenon, typically in order to retain only information which is relevant for a particular purpose.
%% \item \emph{Refinement} - It is the process of elaboration. A hierarchy is developed by decomposing a macroscopic statement of function in a stepwise fashion until programming language statements are reached. In each step, one or several instructions of a given program are decomposed into more detailed instructions. Abstraction and Refinement are complementary concepts.
%% \item \emph{Modularity} - Software architecture is divided into components called modules.
%% \item \emph{Software Architecture} - It refers to the overall structure of the software and the ways in which that structure provides conceptual integrity for a system. A good software architecture will yield a good return on investment with respect to the desired outcome of the project, e.g. in terms of performance, quality, schedule and cost.
%% \item \emph{Control Hierarchy} - A program structure that represent the organization of a program components and implies a hierarchy of control.
%% \item \emph{Structural Partitioning} - The program structure can be divided both horizontally and vertically. Horizontal partitions define separate branches of modular hierarchy for each major program function. Vertical partitioning suggests that control and work should be distributed top down in the program structure.
%% \item \emph{Data Structure} - It is a representation of the logical relationship among individual elements of data.
%% \item \emph{Software Procedure} - It focuses on the processing of each modules individually
%% \item \emph{Information Hiding} - Modules should be specified and designed so that information contained within a module is inaccessible to other modules that have no need for such information.
%% \end{itemize}

\subsection{Aspekty návrhu software}
Při návrhu software musíme vzít v potaz velké množství aspektů \cite{wiki:software_design}. Důležitost přikladaná jednotlivým aspektům je odvozena od účelu, za nímž je software realizován. Pro některé systémy může být klíčové rozšiřitelnost, pro jiné stabilita. Mezi základní aspekty patří:

\begin{itemize}
\item \emph{kompatibilita (compatibility)},
\item \emph{rozšiřitelnost (extensibility)},
\item \emph{zotavení se z chyb (fault-tolerance/graceful degradation)} \cite{wiki:fault-tolerance},
\item \emph{udržovatelnost (maintainability)},
\item \emph{modularita (modularity)},
\item \emph{balení (packaging)},
\item \emph{spolehlivost (reliability)},
\item \emph{znovupoužitelnost (reusability)},
\item \emph{stabilita (robustness)},
\item \emph{bezpečnost (security)},
\item \emph{použitelnost (usability)}.
\end{itemize}

Zatímco některé aspekty jsou pro tuto práci zcela nepodstatné (dobrým příkladem budiž \emph{balení}, které se zabývá způsobem dodávky software a podporných materiálů), jiné je možné podpořit pomocí vhodného nástroje. Pojďme se nyní podívat na aspekty, jejichž podpora možná je:

\paragraph{Rozšiřitelnost}
\paragraph{Udržovatelnost}
\paragraph{Modularita}
\paragraph{Znovupoužitelnost}

%% \begin{itemize}
%% \item \emph{Extensibility} - New capabilities can be added to the software without major changes to the underlying architecture.
%% \item \emph{Maintainability} - The software can be restored to a specified condition within a specified period of time. For example, antivirus software may include the ability to periodically receive virus definition updates in order to maintain the software's effectiveness.
%% \item \emph{Modularity} - the resulting software comprises well defined, independent components. That leads to better maintainability. The components could be then implemented and tested in isolation before being integrated to form a desired software system. This allows division of work in a software development project.
%% \item \emph{Reusability} - the software is able to add further features and modification with slight or no modification.
%% \end{itemize}

\section{Analýza principů objektového návrhu}

%% V části analýzy provést rozbor jednotlivých principů + výsledky rešerší - využívat hojně informace z článků a důsledně citovat zdroje

\begin{itemize}
\item co jsou to návrhové principy?
\item návrhové principy versus návrhové vzory \cite{612257}
\end{itemize}

\subsection{Analyzované principy}
Ukázkové návrhové principy analyzované v rámci této práce jsou znázorněny na obrázku \ref{analyzed_principles}. Poznamenejme, že tzv. Demeterův zákon je speciálním případem pravidla pro \uv{low coupling}.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{./graphs/oop_design_principles.png}
  \caption{Znázornění analyzovaných návrhových principů.\label{analyzed_principles}}
\end{figure}

% TODO: v rámci každého návrhového principu uvést příklad porušení
% tohoto principu (případně i příklad, který tento princip dodržuje)

\subsubsection{Low coupling/dependency (nízká závislost/vazba)}
Důležitou návrhovou zásadou je snaha snížit provázanost modulů na minimum. Je možné kategorizovat způsob provázanosti modulů do různých skupin. Následující přehled je převzat z \cite{wiki:coupling} (ještě jemnější dělení je uváděno v \cite{STVR:STVR162}).

\begin{itemize}
\item\emph{Content coupling (nejvyšší forma závislosti)} -- závislost na obsahu modulu -- jeden modul modifikuje nebo se spoléhá na vnitřní fungování jiného modulu (např. přístup k lokálním datům jiného modulu). V důsledku platí, že změní-li se způsob, kterým tento druhý modul produkuje data (umístění, typ, časování), povede to zcela jiste ke změnám v závislém modulu.
\item\emph{Common coupling} -- dva moduly sdílí stejná globální data (např. globální proměnnou), změna sdíleného globálního zdroje implikuje změny všech modulů, které je používají.
\item\emph{External coupling} -- dva moduly sdílí externě definovaný (standardizovaný) datový formát, komunikační protokol nebo rozraní zařízení.
\item\emph{Control coupling} -- jeden modul kontroluje tok druhého tím, že mu posílá informaci o tom, co má konat (např. předání \uv{to-do} příznaku).
  % TODO: CLARIFY
\item\emph{Stamp coupling (Data-structured coupling)} -- mdouly sdílí složenou datovou strukturu a používají pouze její (často odlišnou) část (např. předávání kompletního záznamu funkci, která z něj potřebuje pouze jedno pole). Tato vazba může vést ke změně způsobu, kterým modul čte záznam, protože pole, které tento modul nepotřebuje bylo modifikováno.
  % Stamp coupling is when modules share a composite data structure and use only a part of it, possibly a different part (e.g., passing a whole record to a function that only needs one field of it). This may lead to changing the way a module reads a record because a field that the module doesn't need has been modified.
\item\emph{Data coupling} -- moduly sdílí data pomocí parametrů. Každý parametr je elementární datový typ a jedná se o jediná data, která jsou sdílená (např. předávání celočíselné hodnoty funkci, která spočítá jeho druhou mocninu).
\item\emph{Message coupling (nejnižší forma závislosti)} -- provázanost modulů pouze pomocí zpráv, jedná se o nejnižší úroveň závislosti. Lze jí dosáhnout pomocí decentralizace stavu (u objektů), kde je komunikace dosahováno pomocí parametrů nebo předávání zpráv (\uv{message passing}).
\item\emph{No coupling} -- žádná závislost -- moduly spolu vůbec nekomunikují.
\end{itemize}

%% TODO: sort
%% ## Typy závislostí mezi třídami

%% * třída A dědí ze třídy B
%% * třída A provádí instanciaci třídy B
%% * třída A používá existující intanci třídy B (pracuje s referencí na tuto třídu)

%% Na základě těchto závislostí lze sestavit orientovaný graf. Hrany budeme dále klasifikovat podle toho, o jakou závislost se jedná (dědičnost vs. vyvolání metody).

\subsubsection{High cohesion (vysoká koheze/soudržnost)}
Wikipedia \cite{wiki:cohesion}:
\begin{itemize}
\item míra, jak silně související je funkčnost vyjádřená zdrojovým kódem konkrétního modulu
\end{itemize}

\noindent{}Článek \cite{Kang:1996:DCM:872750.873361}:
\begin{itemize}
\item association-based approach (coincidental, logical, \ldots),
\item slice-based approach,
\item def-use paths,
\item velmi exaktní přístup.
\end{itemize}

\noindent{}Článek \cite{ISI:000079726000029} uvádí dělení koheze podle tzv SMC\footnote{Podle původních autorů Stevens, Myers a Constantine.} Cohesion:
\begin{enumerate}
\item \emph{Coincidental association} -- neexistuje souvislost mezi elementy provádějícími zpracování,
  %\item \emph{Coincidental association} -- there is no relationship between the processing elements.
\item \emph{Logical association} -- oba elementy provádějící zpracování patří do stejné logické třídy příbuzných funkcí,
  %\item \emph{Logical association} -- both processing elements belong to the same logical class of related functions.
\item \emph{Temporal association} -- každý výskyt obou elementů provadějících zpracování je v tom samém omezeném časovém období při provádění programu,
  %\item \emph{Temporal association} -- each occurrence of both processing elements occurs within the same limited period of time during execution.
\item \emph{Procedural association} -- oba elementy provádějící zpracování jsou elementy stejné procedurální jednotky, která je iterativním nebo rozhodovacím procesem,
  %\item \emph{Procedural association} -- both processing elements are elements of a common procedural unit which is an iteration or decision process.
\item \emph{Communicational association} -- oba elementy provádějící zpracování pracují nad stejnou množinou vstupních dat a/nebo produkují stejná výstupní data,
  %\item \emph{Communicational association} -- both processing elements operate upon the same input data set and/or produce the same output data.
\item \emph{Sequential association} -- výstupní data jednoho elementu jsou vstupními daty pro druhý element,
  %\item \emph{Sequential association} -- the output data from one processing element is input to the other processing element.
\item \emph{Functional association} -- oba elementy jsou nezbytné pro provedení jedné funkce/operace.
  %\item \emph{Functional association} -- both processing elements are essential to the performance of a single function.
\end{enumerate}

\subsubsection{Law of Demeter}

Existuje několik forem Demeterova zákona \cite{35588}, které jsou vhodné pro různé oblasti aplikace. Tyto typy jsou znázorněny na obrázku \ref{demeter_law_types}. V \cite{35588} se též pojednává o demeterově zákoně z jiného úhlu -- uvažují se všechny možné třídy, které lze volat bez porušení tohto principu (tzv. preferred suppliers).

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.7\textwidth]{./graphs/demeter_law_types.png}
  \caption{Formy návrhového principu LoD.\label{demeter_law_types}}
\end{figure}

Pro statickou analýzu lze použít \uv{class} formu Demeterova zákona.

% TODO: rozhodnout, kterou verzi Demeterova zákona použít

\emph{Zjednodušená verze \cite{wiki:lod}}

Method M of an object O may only invoke the methods of the following kinds of objects:

\begin{itemize}
\item O itself,
\item M's parameters,
\item any objects created instantiated within M,
\item O's direct component objects,
\item a global variable, accessible by O in the scope of M.
\end{itemize}

\subsection{Ukázky kódu porušujícího některá z pravidel}

\subsubsection{Porušení principu law of Demeter}

% TODO: find some better (real world) example of demeter law violation on the web
\lstset{
  basicstyle=\ttfamily,
  numbers=left,
  numberstyle=\tiny,
  commentstyle=\color{gray}\textit
}
\begin{lstlisting}[language=java]
  package violations;

  public class DemeterLawViolation {

    void method(MyClass obj, int val) {

      obj.getSomeInternalField().setValue(val);

      // hidden violation:
      InternalFieldDef internalField =
      obj.getSomeInternalField();
      internalField.setValue(val);

    }

  }
\end{lstlisting}

\section{Analýza problematiky v jazyce Java}

\subsection{Statický model programu v Javě}
% TODO: pojednání o tom, co všechno může být modelem programu (ast, graf, FSM, programovací jazyky, atd)
% TODO: model driven engineering, kód je fyzický model, můžeme jej ale dále převádět na další modely a ty potom analyzovat
% TODO: možná přidat poznámku o model driven engineering a jak může být aplikováno právě zde

\subsubsection{Struktura softwarového projektu v Javě}

% TODO: sort and rephrase

\begin{itemize}
\item \verb+*.java+ soubory -- v gramatice programovacího jazyka Java 1.5 představují top-level element CompilationUnit,
\item binární součásti projektu (např. knihovny) -- \verb+*.jar+ soubory, \verb+*.class+ soubory,
\item build scripty a konfigurační soubory sestavovacích nástrojů (\verb+build.xml+, \verb+pom.xml+, \ldots),
\item zdroje (resources, resource bundles),
\item dokumentace (\verb+javadoc+, \ldots),
\item soubory gramatik pro parsery (např. pro \verb+lex+, \verb+flex+, \verb+javacc+, \verb+antlr+, atd.),
\item šablony (typické třeba pro webové projekty, \verb+*.xhtml+ a jiné přípony),
\item konfigurační soubory (zpravidla \verb+*.xml+ soubory, často odkazují konkrétní třídy progamovacího jazyka Java),
\item jiné soubory
\end{itemize}

Pro naše potřeby jsou důležité v podstatě pouze kompilační jednotky (\verb+*.java+ soubory) projektu.

%% TODO: odstranit další výskyty této myšlenky v textu (aby tato věta byla jen na jednom místě)
Statický pohled na program - neuvažujeme běh programu. Pracujeme nad definicemi tříd, nikoliv nad jejich instancemi v paměti JVM.

%% TODO: provést merge s předchozí větou
Budeme provádět statickou analýzu kódu. Pracujeme nad definicemi tříd. Neuvažujeme tedy všechny možné běhové instance programu (všechny možné stavy objektů v paměti virtuálního stroje).

Projekt závisí na dalších třídách, které analyzovat nebudeme (v určitém okamžiku analýzy je potřeba se \uv{odříznout}, jinak bychom mohli analyzovat všechny knihovny, s nimiž projekt pracuje). Takové závislosti mohou být např.:

\begin{itemize}
\item knihovny třetích stran
\item standardní knihovna jazyka Java (např. Java 2 Platform SE 5.0 API pro Javu verze 5) -- zde například budou povoleny závislosti ze všech modulů (ale pro jiné druhy analýzy to může být nežádoucí - např. u logování budeme chtít, aby v projektu šlo striktně přes nějakou naši konkrétní \emph{fasádu})
\item podprojekty a části projektu, které analyzovat nechceme, nepotřebujeme nebo z nějakého důvodu nemůžeme
\end{itemize}

% TODO: aktualizovat -> v konecnem dusledku budeme pracovat i nad projekty v jazyku 1.6 (protoze nam to rozhrani umoznuje)
Budeme pracovat nad gramatikou jazyka Java 1.5. Java verze 6 se liší pouze úpravou standardních API poskytovaných platformou Java. Jazyk jako takový zůstává stejný.

\subsubsection{Syntaktické elementy programovacího jazyka Java}
Grafické znázornění základních syntaktických elementů, jejichž struktura a názvy jsou převzaty z \cite{Gosling:2005:JLS:1036643}, je na obrázku \ref{toplevel_elements}.
% TODO: write some better accompanying text
\begin{figure}[h!]
  \centering
  \includegraphics[width=\textwidth]{./graphs/java_top_elements.png}
  \caption{Struktura základních syntaktických elementů programovacího jazyka Java.\label{toplevel_elements}}
\end{figure}

Pro analýzu založenou na vyhledávání závislostí mezi třídami pro nás bude nejdůležitější syntaktický element \emph{TypeDeclaration}. Tento neterminální symbol se dále přepisuje na symboly uvedené na obrázku \ref{type_declaration_options}.

\begin{figure}[h!]
  \centering
  \includegraphics[width=\textwidth]{./graphs/toplevel_types.png}
  \caption{Rozklad elementu TypeDeclaration.\label{type_declaration_options}}
\end{figure}

%% TODO: zatridit tyto syntakticke elementy, ke kazdemu napsat, jak se bude zpracovavat
%% interfaces
%% enums
%% annotations

%% Modifikátory přístupu (private, public, protected, package private) nám umožní "ořezat" graf závislosti tříd.
% Je ale možné, že pro některé druhy analýzy bude toto nežádoucí.

%% ## Speciální případy:

%% * statické třídy
%% * statické metody
%% * vnitřní třídy

%% hlavní analyzované vazby
% instanciace třídy
% dedicnost (inheritance)
% vyvolání metody

%% zpracovávání kódu -> zejména je potřeba resolvovat plná jména a použití elementů v kódu

\subsection{Existující nástroje pro zpracování zdrojových kódů v jazyku Java}

% TODO: write some leading text

Možnosti zpracovávání kódu:

% TODO: roztřídit a vyházet nesmysly
% TODO: použít jinou vhodnější strukturu místo itemize (např. strukturovaný text)

\begin{itemize}
\item vlastní hand-written lexikální a syntaktický analyzátor (zbytečně náročné)
\item parser vygenerovaný pomocí některého z dostupných compiler-compiler systémů
  \begin{itemize}
  \item tyto systémy na základě vstupní gramatiky vygenerují frontend pro překladač
  \item lze specifikovat různé akce, které jsou navázány na události vyvolané v průběhu syntaktické analýzy
  \item \emph{JavaCC} \cite{parsertools:javacc}
    \begin{itemize}
    \item součástí je nástroj \emph{JJTree}, který je schopen vygenerovat AST pro další práci
    \end{itemize}
  \item \emph{JastAdd} \cite {parsertools:jastadd}
  \item \emph{JLex} \cite{parsertools:jlex}
    \begin{itemize}
    \item A Lexical Analyzer Generator for Java(TM)
    \end{itemize}
  \item JFlex \cite{parsertools:jflex}
    \begin{itemize}
    \item The Fast Scanner Generator for Java
    \end{itemize}
  \end{itemize}
\item použití vhodné knihovny
  \begin{itemize}
  \item JavaParser \cite{parsertools:javaparser}
    \begin{itemize}
    \item projekt na GoogleHosting
    \item v podstatě gramatika pro JJTree vytvářející strom tříd a objektů, který je možné procházet pomocí visitor patternu
    \end{itemize}
  \end{itemize}
\item použití prostředků platformy NetBeans \cite{parsertools:javasourcejavadoc}
  \begin{itemize}
  \item Java Source API
  \end{itemize}
\item použití prostředků poskytovaných platformou Java 6 (Sun verze) \cite{source_code_analysis_corejavatechtips}
  \begin{itemize}
  \item \emph{JSR 199 -- Java Compiler API}
    \begin{itemize}
    \item volání překladače jazyka Java pomocí API ze zdrojového kódu programu
    \item balíček \verb+javax.tools+
    \end{itemize}
  \item \emph{JSR 269 -- Pluggable Annotation Processing API}
    \begin{itemize}
    \item možnost přidání vlastního kódu pro zpracovávání anotací/kódu do instance překladače
    \item balíček \verb+javax.annotation.processing+ -- zpracovávání anotací
    \item balíček \verb+javax.lang.model+ -- třídy poskytující model pro syntaktické elementy jazyka Java
    \end{itemize}
  \item \emph{Compiler Tree API} \cite{parsertools:compilertreeapi}
    \begin{itemize}
    \item nestandardní rozšíření Java JDK
    \item balíček \verb+com.sun.source.tree+ -- poskytuje rozhraní pro reprezentaci zdrojového kódu jako AST
    \item balíček \verb+com.sun.source.util+ -- poskytuje rozhraní pro operace nad AST
    \end{itemize}
  \end{itemize}
\item použití prostředků, které jsou k dispozici pro platformu Eclipse
  \begin{itemize}
  \item org.eclipse.jdt.core.dom package
  \item spoon \cite{parsertools:spoon}
  \end{itemize}
\end{itemize}

% TODO: zatřídit:

Důležité části zpracování kódu:

\begin{itemize}
\item name resolution, jmenné prostory (namespaces), class loaders, class tables
\item static classes, methods
\item inner classes
\item polymorphism
\item generické třídy, wildcards
\item pole objektů
\item návratové typy metod
\item vstupní parametry metod
\item lokální proměnné
\item globální objekty (statické metody a pole tříd, singletony - opět ale pouze ze statického pohledu!)
\item vizualizace grafu
\end{itemize}

% TODO: zatřídit

úrovně práce:

\begin{itemize}
\item design level -- analýza správného návrhu softwarového díla (pracuje se na konceptuální úrovni, ještě není hotový kód)
\item code level -- analýza existujícího kódu z pohledu návrhu (již máme kód, ale chceme zpětně ověřit, že představuje dobrý/špatný návrh)
\end{itemize}
